name: Build and test.

permissions: {}

on:
  pull_request:
    branches: ["**"]
  workflow_dispatch: {}

env:
  # Keep native C++ tests off for speed in this CI (they run in upstream CI)
  DISABLE_NATIVE_BINARY_TESTS: true

  # Feature flags for this CI
  BUILD_LINUX: true
  BUILD_MACOS_ARM: true
  BUILD_MACOS_INTEL: false
  BUILD_WINDOWS: false

jobs:
  # Tiny config fan-out
  config:
    runs-on: ubuntu-latest
    outputs:
      build_linux: ${{ steps.set.outputs.build_linux }}
      build_windows: ${{ steps.set.outputs.build_windows }}
      build_macos_intel: ${{ steps.set.outputs.build_macos_intel }}
      build_macos_arm: ${{ steps.set.outputs.build_macos_arm }}
    steps:
      - id: set
        run: |
          echo "build_linux=${{ env.BUILD_LINUX }}" >> $GITHUB_OUTPUT
          echo "build_windows=${{ env.BUILD_WINDOWS }}" >> $GITHUB_OUTPUT
          echo "build_macos_intel=${{ env.BUILD_MACOS_INTEL }}" >> $GITHUB_OUTPUT
          echo "build_macos_arm=${{ env.BUILD_MACOS_ARM }}" >> $GITHUB_OUTPUT

  linux:
    name: Build and test wheels for Linux (manylinux aarch64 via cibuildwheel)
    permissions:
      contents: read
    needs: config
    if: ${{ needs.config.outputs.build_linux == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Needed to emulate aarch64 manylinux on x86_64 runner
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Python (host)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install cibuildwheel
        run: python -m pip install --upgrade pip cibuildwheel

      - name: Build wheels (manylinux aarch64)
        env:
          # Build the Python versions we care about
          CIBW_BUILD: "cp311-* cp312-* cp314-*"
          CIBW_ARCHS_LINUX: "aarch64"
          # Skip musllinux unless you target Alpine
          CIBW_SKIP: "pp* *-musllinux_*"
          # If BLAS/ATLAS is needed inside the manylinux image, uncomment:
          # CIBW_BEFORE_ALL_LINUX: "yum install -y atlas-devel || true"
        run: python -m cibuildwheel --output-dir wheelhouse python_bindings

      - name: Upload wheels (Linux aarch64)
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-aarch64
          path: wheelhouse/*.whl
          if-no-files-found: error

  macos-arm64:
    name: Build and test wheels for macOS arm64 (Apple Silicon)
    needs: config
    if: ${{ needs.config.outputs.build_macos_arm == 'true' }}
    runs-on: macos-14   # Apple Silicon runner
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python (host)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install cibuildwheel
        run: python -m pip install --upgrade pip cibuildwheel

      - name: Build wheels (macOS arm64)
        env:
          CIBW_BUILD: "cp311-* cp312-* cp314-*"
          CIBW_ARCHS_MACOS: "arm64"
          CIBW_ENVIRONMENT_MACOS: >
            MACOSX_DEPLOYMENT_TARGET=11.0
            ARCHFLAGS="-arch arm64"
            FORCE_MACOS_ARM=1
          # Basic import smoke test for each built wheel
          CIBW_TEST_COMMAND: "python -c \"import nmslib; print(nmslib.__version__)\""
          # If you need OpenMP/BLAS on macOS, you can uncomment:
          # CIBW_BEFORE_ALL_MACOS: "brew update && brew install libomp || true"
          # and possibly set:
          # CFLAGS: "-I/opt/homebrew/opt/libomp/include"
          # LDFLAGS: "-L/opt/homebrew/opt/libomp/lib -lomp"
        run: python -m cibuildwheel --output-dir wheelhouse python_bindings

      - name: Upload wheels (macOS arm64)
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-arm64
          path: wheelhouse/*.whl
          if-no-files-found: error

  source_dist:
    name: Build source distribution (sdist)
    permissions:
      contents: read
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build sdist
        run: |
          cd python_bindings
          python -m pip install --upgrade pip setuptools wheel
          python setup.py sdist

      - name: Upload source artifact
        uses: actions/upload-artifact@v4
        with:
          name: source-dist
          path: python_bindings/dist/*.tar.gz

  aggregate:
    name: Aggregate all build artifacts
    needs:
      - macos-arm64
      - linux
      - source_dist
    runs-on: ubuntu-24.04
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: combined-artifacts

      - name: Show combined contents (optional)
        run: ls -R combined-artifacts

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-platform-builds
          path: combined-artifacts/

